name: Convert CCI List XML to JSON

on:
  push:
    # branches: ['master']
    branches: ['add-convert-cci-list-workflow']

  # Run this workflow at 00:00 every month
  # schedule:
  # - cron: '0 0 1 * *'

env:
  # This URL is super brittle with how links constantly get changed.
  CCI_LIST_ZIP_URL: https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/U_CCI_List.zip

jobs:
  convert-cci-list:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          check-latest: true
          cache: 'yarn'

      - name: Install project dependencies
        run: yarn install --frozen-lockfile

      - name: Download CCI List
        run: |
          curl -o U_CCI_List.zip $CCI_LIST_ZIP_URL && unzip U_CCI_List.zip
          ls -lta
          pwd

      - name: Get publish date of CCI List
        id: publish-date
        uses: mavrosxristoforos/get-xml-info@2.0
        with:
          xml-file: 'U_CCI_List.xml'
          xpath: '//metadata/publishdate'
          namespaces: '{"ns": "http://iase.disa.mil/cci"}'

      - name: Convert CCI List XML to two JSON files
        run: yarn workspace @mitre/hdf-converters cciListXml2json /U_CCI_List/U_CCI_List.xml U_CCI_List.nist.json U_CCI_List.defs.json

      - name: Update CCI to NIST and CCI to Definition mappings
        run: |
          mv U_CCI_List.nist.json libs/hdf-converters/src/mappings/
          mv U_CCI_List.defs.json libs/hdf-converters/src/mappings/

      - name: Commit changes to CciNistMappingData.ts
        env:
          DATETIME: ${{steps.publish-date.outputs}}
        # run: |
        # git config --local user.email "saf@groups.mitre.org"
        # git config --local user.name "MITRE SAF Automation"
        # git add libs/hdf-converters/src/mappings/CciNistMappingData.ts
        # git commit -sm "Update CCI List to the current NIST and definition mappings as of $DATETIME"
        # git push
        run: |
          echo $DATETIME
